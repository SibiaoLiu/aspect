#### Orogen-Foreland compressional model example
# This cookbook is based off numerous published studies, three of which are listed below.
# For additional information, see these publications and references therein.
#   1. Brune, S., Heine, C., Perez-Gussinye, M., and Sobolev, S.V. (2014), Nat. Comm., v.5, n.4014,
#      Rift migration explains continental margin asymmetry and crustal hyperextension
#   2. Huismans, R., and Beaumont, C. (2011), Nature, v.473, p.71-75.
#      Depth-dependent extension, two-stage breakup and cratonic underplating at rifted margins
#   3. Naliboff, J., and Buiter, S.H. (2015), Earth Planet. Sci. Lett., v.421, p.58-67,
#      "Rift Reactivation and migration during multiphase extension"

####  Global parameters
set Dimension                              = 2
set Start time                             = 0
set End time                               = 5e6
set Use years in output instead of seconds = true
set CFL number				   = 0.5
set Maximum time step			   = 1e6

set Nonlinear solver scheme                = single Advection, iterated Stokes
set Nonlinear solver tolerance             = 2e-5
set Max nonlinear iterations               = 10

set Output directory                       = 2d_crust36_inilow
set Pressure normalization                 = no
#set Timing output frequency               = 0
set Resume computation                     = auto

#### Parameters describing the model

# Model geometry (400*400 km, 0.625 km spacing)
subsection Geometry model
  set Model name = box
  subsection Box
    set X repetitions = 40
    set Y repetitions = 40
#    set Z repetitions = 40
    set X extent      = 400e3
    set Y extent      = 400e3
#    set Z extent      = 200e3

  end
end

# Mesh refinement specifications 
subsection Mesh refinement
  set Initial adaptive refinement        = 0
  set Initial global refinement          = 0
#  set Additional refinement times        = 1e4,5e4
  set Time steps between mesh refinement = 10
  set Strategy                           = minimum refinement function
  set Refinement fraction                = 0.95                 #?
  set Coarsening fraction                = 0.05
  subsection Minimum refinement function
    set Coordinate system = cartesian
    set Variable names = x,y
    set Function constants = h=400.e3, hd2=80.e3
    set Function expression = if(y>=(h-hd2),4,0)
  end
#  set Normalize individual refinement criteria = true          #false
#  set Refinement criteria merge operation = max                #plus
end

# Boundary classifications
# Composition: fixed on bottom, free on sides and top
# Velocity: free surface on top, inflow on right foreland side, outflow at base
# Temperature: fixed at top and bottom, insulating sides
# The parameters below this comment were created by the update script
# as replacement for the old 'Model settings' subsection. They can be
# safely merged with any existing subsections with the same name.

subsection Boundary composition model
  set Fixed composition boundary indicators   = bottom, left, right
end

subsection Boundary temperature model
  set Fixed temperature boundary indicators   = bottom, top
end

subsection Boundary velocity model
  set Prescribed velocity boundary indicators = right x:function, left x: function
end

subsection Free surface
  set Free surface boundary indicators        = top
end

subsection Boundary velocity model
  set Tangential velocity boundary indicators = bottom
end

# Advecting the free surface vertically rather than
# in the surface normal direction can result in a
# more stable mesh when the deformation is large
subsection Free surface
  set Surface velocity projection = vertical
  set Free surface stabilization theta = 1.0  #0-1
end

# Velocity on boundaries characterized by functions
# The compression inward velocity (x-direction) on the right side is linear increase from 0.5 at y=0 to 2.5 cm/year at y=800km
# The vertical velocity at the base is -0.25 cm/year (i.e., open the bottom, balances outflow on sides)

subsection Boundary velocity model
  subsection Function
    set Variable names      = x,y
    set Function constants  = cm=0.01, year=1,  widthy=400e3
    set Function expression = if(x>395.e3 && y>=300.e3, -2*cm/year, if(x<5.e3 && y<=100.e3, -2*cm/year, 0)); 0
  end
end


# Number and names of compositional fields
# The four compositional fields represent the background upper mantle, lithospheric mantle, mafic crust, felsic crust, sediment in plateau and foreland
# and a 'seed' placed in the mantle to help localize deformation.
subsection Compositional fields
  set Number of fields = 5
  set Names of fields = mantle, lithomantle, mafic, plastic_strain, sediment
end


# Spatial domain of different compositional fields
subsection Initial composition model
  set Model name = function
  subsection Function
    set Variable names      = x,y
    set Function constants  = hb=250.e3, widthy=400.e3
    set Function expression = if(y<300e3, 1, 0); \
                              if(y>=300e3 && y<364.e3, 1, 0); \
                              if(y>=364.e3 && y<376.e3, 1, 0); \
                              if((x<hb && y>=376.e3) || (x>=hb && y>=376.e3 && y<396e3), 1, 0); \
                              if(x>=hb && y>=396e3, 1, 0);
  end
end

# Composition boundary conditions
subsection Boundary composition model
  set List of model names = initial composition
end

# Temperature boundary conditions
# Top and bottom (fixed) temperatures are consistent with the initial temperature field
# Note that while temperatures are specified for the model sides, these values are
# not used as the sides are not specified "Fixed temperature boundaries".  Rather,
# these boundaries are insulating (zero net heat flux).
subsection Boundary temperature model
  set List of model names = box
  subsection Box
    set Bottom temperature = 1733		# 400km-depth: T=1300+0.4*400+273
    set Top temperature    =  273
  end
end

# Initial temperature field
# Typical continental geotherm based on equations 4-6 from:
#   D.S. Chapman (1986), "Thermal gradients in the continental crust",
#   Geological Society of London Special Publications, v.24, p.63-70.
# The initial constraints are:
#   Layer Surface Temperature - upper crust (ts1) = 273 K; 
#                               mantle      (ts3) = 823 K;  
#   Model Base Temperature - (tb) = 1573 K;
#   Heat Production - upper crust (A) = 1.5e-6 W/m^3; 
#   Thermal Conductivity - upper crust (k1) = 2.5 (W/(m K)); 
#                          lower crust (k2) = 2.5 (W/(m K)); 
#                          mantle      (k3) = 3.3 (W/(m K));
# To satisfy these constraints, the following values are required:
#   Layer Surface Heat Flow - upper crust (qs1) = 0.065357 W/m^2; 
#                             lower crust (qs2) = 0.035357 W/m^2; 
#                             mantle      (qs3) = 0.035357 W/m^2;
#   Temperature - base of upper crust (ts2) = 681.5714
subsection Initial temperature model
  set Model name = function
  subsection Function
    set Variable names = x,y
    set Function constants = h=400.e3,h1=100.e3,h2=100.e3,ts=273,tb=1613,tb1=1613, widthy=400.e3
    set Function expression = if(y>=300.e3, ts + (tb-ts)*(h-y)/h1, ts+1300+0.4*(h-y)/1.e3);
  end
end

# Constant internal heat production values (W/m^3) for background material
# and compositional fields.
subsection Heating model
  set List of model names = compositional heating #, shear heating, adiabatic heating
  subsection Compositional heating
#    set Compositional heating values = 0., 0., 0., 0., 1.5e-6, 1.5e-6
    set Compositional heating values = 0., 0., 0., 0.3e-6, 1.0e-6, 1.3e-6, 
  end
#  subsection Adiabatic heating
#    set Use simplified adiabatic heating = true
#  end 
end

# Material model
# Rheology: Non-linear viscous flow and Drucker Prager Plasticity
# Values for most rheological parameters are specified for a background material and
# each compositional field.  Values for viscous deformation are based on dislocation
# creep flow-laws, with distinct values for the upper crust (wet quartzite), lower
# crust (wet anorthite) and mantle (dry olivine).  Table 1 of Naliboff and Buiter (2015),
# Earth Planet. Sci. Lett., v.421, p. 58-67 contains values for each of these flow laws.     
subsection Material model
  set Model name = visco plastic

  subsection Visco Plastic

    # Reference temperature and viscosity
    set Reference temperature = 323
    set Reference viscosity = 1e22
    
    # The minimum strain-rate helps limit large viscosities values that arise
    # as the strain-rate approaches zero.
    # The reference strain-rate is used on the first non-linear iteration
    # of the first time step when the velocity has not been determined yet. 
    set Minimum strain rate = 1.e-20
    set Reference strain rate = 1.e-16

    # Limit the viscosity with minimum and maximum values
    set Minimum viscosity = 1e19
    set Maximum viscosity = 1e24

    # Thermal diffusivity is adjusted to match thermal conductivities (k)
    # assumed in assigning the initial geotherm
    set Thermal diffusivities =  8.333333e-7, 8.333333e-7, 8.333333e-7, 7.142857e-7, 7.440476e-7, 8.333333e-7   	#kappa=k/(rho*Cp), m2/s
    set Heat capacities       =     1200, 	 1200.,       1200.,       1200.,       1200.,        1200.
    set Densities             =     3300,	 3300,        3300,        3000,        2800,         2500
    set Thermal expansivities =     3.e-5, 	 3.e-5,       3.e-5,       2.7e-5,      3.7e-5,       3.7e-5

    # Harmonic viscosity averaging
    set Viscosity averaging scheme = harmonic

    # Choose to have the viscosity (pre-yield) follow a dislocation
    # diffusion or composite flow law.  Here, dislocation is selected
    # so no need to specify diffusion creep parameters below, which are
    # only used if "diffusion" or "composite" option is selected.
    set Viscous flow law = composite 			

    # Dislocation creep parameters for 
    # 1. Background material/mantle (dry olivine)
    #    Hirth & Kohlstedt (2004),  Geophys. Monogr. Am. Geophys. Soc., v.138, p.83-105.
    #    "Rheology of the upper mantle and the mantle wedge:a view from the experimentalists"
    # 2. Upper crust (wet quartzite)
    #    Rutter & Brodie (2004), J. Struct. Geol., v.26, p.2011-2023.
    #    "Experimental grain size-sensitive flow of hot-pressed Brazilian quartz aggregates"
    # 3. Lower crust and weak seed (wet anorthite)
    #    Rybacki et al. (2006), J. Geophys. Res., v.111(B3).
    #    "Influence of water fugacity and activation volume on the flow properties of fine-grained    
    #    anorthite aggregates"
    # Note that the viscous pre-factors below are scaled to plane strain from unixial strain experiments.
#    set Prefactors for dislocation creep          = 6.52e-16, 6.52e-16,6.52e-16, 7.13e-18, 8.57e-28, 8.57e-28
#    set Stress exponents for dislocation creep    =   3.5, 3.5, 3.5, 3.0, 4.0,  4.0
#    set Activation energies for dislocation creep =   530.e3,  530.e3, 530.e3, 345.e3,  223.e3, 223.e3
#    set Activation volumes for dislocation creep  =   18.e-6,  18.e-6, 18.e-6, 0., 0., 0.

    set Prefactors for dislocation creep          = 2.03e-15, 2.03e-15, 6.22e-16, 5.78e-27, 8.57e-28, 8.57e-28
    set Stress exponents for dislocation creep    =    3.5,     3.5,      3.5,      4.7,      4.0,      4.0
    set Activation energies for dislocation creep =   480.e3,  480.e3,   530.e3,   485.e3,   223.e3,   223.e3
    set Activation volumes for dislocation creep  =   11.e-6,   11.e-6,   15.e-6,      0.,       0.,     0.

    set Prefactors for diffusion creep          =    1.0e-15,     1.0e-15,      1.5e-15,      1.0e-30,       1.0e-30,    1.0e-30
    set Stress exponents for diffusion creep    =    1.0
    set Activation energies for diffusion creep =   335.e3,      335.e3,      375.e3,      335.e3,       335.e3,    335.e3
    set Activation volumes for diffusion creep  =   4.e-6,       4.e-6,       5.e-6,        4.e-6,       4.e-6,    4.e-6
    set Grain size exponents for diffusion creep = 3
    set Grain size = 1e-2			
     #10 mm for the wet diffusion olivine (constant COH) from Hirth and Kohlstedt, 2003

    # Plasticity parameters
    set Angles of internal friction =   30.,  	30.,   	30.,  	30.,    30., 	3.
    set Cohesions                   =   40.e6,  40.e6, 	40.e6,  40.e6,  20.e6,  1.e6
    set Use strain weakening        = true
    set Use plastic strain weakening        = true
    set Start plasticity strain weakening intervals = 0.5
    set End plasticity strain weakening intervals = 1.5
    set Friction strain weakening factors = 1., 1., 1., 1., 0.2,  1.
    set Cohesion strain weakening factors = 1., 1., 1., 1., 0.05, 1.
#    set Viscous strain weakening factors =

  end
end

#Incompressible condition
#subsection Formulation
#  set Formulation = custom
#  set Mass conservation = incompressible
#  set Temperature equation = reference density profile
#end

# Gravity model
subsection Gravity model
  set Model name = vertical

  subsection Vertical
    set Magnitude = 9.81
  end
end

# For restarting the model
subsection Checkpointing
  set Steps between checkpoint = 10
#  set Time between checkpoint = 100
end

# Decreasing the DoFs in Temperature and composition
subsection Discretization
  set Composition polynomial degree 		   = 2
  set Temperature polynomial degree 		   = 2
  set Stokes velocity polynomial degree            = 2
end


# Post processing
subsection Postprocess
  set List of postprocessors = velocity statistics, basic statistics, memory statistics, topography, temperature statistics, visualization
  subsection Visualization
#    set List of output variables = adiabat, compositional vector, depth, dynamic topography, error indicator, maximum horizontal compressive stress, shear stress, strain rate, stress, viscosity 

    set Output format = vtu
    set Time between graphical output = 1e6
#    set Interpolate output = true
    set Number of grouped files             = 1
  end
end

subsection Solver parameters
#set Temperature solver tolerance	   = 1e-8
end

subsection Solver parameters
  subsection Stokes solver parameters
    set Linear solver tolerance = 1e-7
    set Maximum number of expensive Stokes solver steps = 10000
    set Number of cheap Stokes solver steps = 0
    set Use direct solver for Stokes system = false
  end
end
